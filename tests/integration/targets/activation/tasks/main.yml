---
- name: "Run preparations."
  ansible.builtin.import_role:
    name: server
  vars:
    checkmk_server_version: "{{ item.version }}"
    checkmk_server_edition: "{{ item.edition }}"
    checkmk_server_sites:
      - name: "{{ item.site }}"
        version: "{{ item.version }}"
        admin_pw: "{{ automation_secret }}"
  loop: "{{ test_sites }}"

- name: "Start Sites."
  ansible.builtin.shell: "omd status -b {{ item.site }} || omd start {{ item.site }}"
  register: site_status
  changed_when: site_status.rc == "0"
  loop: "{{ test_sites }}"

- name: "Wait for site to be ready."
  ansible.builtin.pause:
    seconds: 5
  when: "'OVERALL 1' in item.stdout_lines"
  loop: "{{ site_status.results }}"

- name: "Testing."
  ansible.builtin.include_tasks: test.yml
  loop: "{{ test_sites }}"
  loop_control:
    loop_var: outer_item
