---
- name: "{{ outer_item.version }} - Download Checkmk Version."
  ansible.builtin.get_url:
    url: "{{ download_url }}"
    dest: /tmp/checkmk-server-{{ outer_item.site }}.deb
    mode: "0640"

- name: "{{ outer_item.version }} - Install Checkmk Version."
  ansible.builtin.apt:
    deb: /tmp/checkmk-server-{{ outer_item.site }}.deb
    state: present

- name: "{{ outer_item.version }} - Create Site."
  ansible.builtin.command: "omd create --no-tmpfs --admin-password {{ automation_secret }} {{ outer_item.site }}"
  args:
    creates: "/omd/sites/{{ outer_item.site }}"

- name: "{{ outer_item.version }} - Start Site."
  ansible.builtin.shell: "omd status -b {{ outer_item.site }} || omd start {{ outer_item.site }}"
  register: site_status
  changed_when: site_status.rc == "0"

- name: "Wait for site to be ready."
  ansible.builtin.pause:
    seconds: 5
  when: "'OVERALL 1' in site_status.stdout_lines"