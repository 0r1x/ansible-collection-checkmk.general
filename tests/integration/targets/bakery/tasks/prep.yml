---
- name: "Download Checkmk Versions."
  ansible.builtin.get_url:
    url: "{{ download_url }}"
    url_username: " {{ download_user }}"
    url_password: "{{ download_pw }}"
    dest: /tmp/checkmk-server-{{ item.site }}.deb
    mode: "0640"
  loop: "{{ checkmk_versions }}"

- name: "Install Checkmk Versions."
  ansible.builtin.apt:
    deb: /tmp/checkmk-server-{{ item.site }}.deb
    state: present
  loop: "{{ checkmk_versions }}"

- name: "Create Sites."
  ansible.builtin.command: "omd create --no-tmpfs --admin-password {{ automation_secret }} {{ item.site }}"
  args:
    creates: "/omd/sites/{{ item.site }}"
  loop: "{{ checkmk_versions }}"

- name: "Start Sites."
  ansible.builtin.shell: "omd status -b {{ item.site }} || omd start {{ item.site }}"
  register: site_status
  changed_when: site_status.rc == "0"
  loop: "{{ checkmk_versions }}"

- name: "Inject a Key into the Sites."  # This is a hack and should never be done in production!
  ansible.builtin.copy:
    src: agent_signature_keys.mk
    dest: "/omd/sites/{{ item.site }}/etc/check_mk/multisite.d/wato/agent_signature_keys.mk"
    owner: "{{ item.site }}"
    group: "{{ item.site }}"
    mode: "0660"
  loop: "{{ checkmk_versions }}"
