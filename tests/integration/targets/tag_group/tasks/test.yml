---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    customer: "provider"
  when: (outer_item.edition == "cme") or (outer_item.edition == "cce")

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    customer: null
  when: not ((outer_item.edition == "cme") or (outer_item.edition == "cce"))

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create tag_group."
  tag_group:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    id: Virtualization
    title: Virtualization
    topic: My_Tag_Group
    choices:
      - id: No_Virtualization
        title: No Virtualization
      - id: ESXi
        title: ESXi
      - id: vCenter
        title: vCenter
      - id: HyperV
        title: Hyper
      - id: KVM
        title: KVM
    state: "present"
  delegate_to: localhost

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate changes."
  activation:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update tag_group."
  tag_group:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    id: Virtualization
    title: Hypervisors
    topic: My_Tag_Group
    choices:
      - id: No_Virtualization
        title: No Virtualization
      - id: ESXi
        title: ESXi
      - id: vCenter
        title: vCenter
      - id: HyperV
        title: Hyper
    state: "present"
  delegate_to: localhost

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate changes."
  activation:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete tag_group."
  tag_group:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    id: Virtualization
    title: Hypervisors
    topic: My_Tag_Group
    choices:
      - id: No_Virtualization
        title: No Virtualization
      - id: ESXi
        title: ESXi
      - id: vCenter
        title: vCenter
      - id: HyperV
        title: Hyper
    state: "absent"
  delegate_to: localhost

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate changes."
  activation:
    server_url: "{{ server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ automation_user }}"
    automation_secret: "{{ automation_secret }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
